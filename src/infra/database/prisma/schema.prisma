generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AuthProvider {
  local
  google
}

enum UserRole {
  admin
  common
  enterprise
  professional
  therapist
}

enum FamilyRole {
  child
  enterprise
  manager
  therapist
  professional
}

enum TaskStatus {
  pending
  in_progress
  done
  canceled
}

model User {
  id           String       @id @default(uuid()) @db.Uuid
  name         String
  email        String?      @unique
  passwordHash String?      @map("password_hash")
  provider     AuthProvider @default(local)
  googleId     String?      @unique @map("google_id")
  role         UserRole     @default(common)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  refreshTokens RefreshToken[]
  familyMembers FamilyMember[]

  tasksAssigned Task[] @relation("TaskTherapist")
  tasksReceived Task[] @relation("TaskUser")

  @@map("users")
  @@index([provider])
  @@index([createdAt])
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid @map("user_id")
  tokenHash String   @unique @map("token_hash")

  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
  @@index([userId])
  @@index([expiresAt])
  @@index([revokedAt])
}

model Family {
  id   String @id @default(uuid()) @db.Uuid
  name String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members FamilyMember[]

  @@map("families")
  @@index([createdAt])
}

model FamilyMember {
  id       String     @id @default(uuid()) @db.Uuid
  userId   String     @db.Uuid @map("user_id")
  familyId String     @db.Uuid @map("family_id")
  role     FamilyRole

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([userId, familyId, role])

  @@map("family_members")
  @@index([familyId])
  @@index([familyId, role])
  @@index([userId])
}

model Task {
  id          String     @id @default(uuid()) @db.Uuid
  therapistId String     @db.Uuid @map("therapist_id")
  userId      String     @db.Uuid @map("user_id")

  status      TaskStatus @default(pending)
  title       String
  description String?
  feedback    String?
  note        String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  therapist User @relation("TaskTherapist", fields: [therapistId], references: [id], onDelete: Cascade)
  user      User @relation("TaskUser", fields: [userId], references: [id], onDelete: Cascade)

  @@map("tasks")
  @@index([therapistId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}
